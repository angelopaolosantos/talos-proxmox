# istio-gateway-metallb.yaml
# This configuration patches the Istio ingress gateway to use our dedicated
# MetalLB IP pool and optionally request a specific IP address
---
apiVersion: v1
kind: Service
metadata:
  name: istio-ingressgateway
  namespace: istio-system
  annotations:
    # Tell MetalLB to use our dedicated Istio IP pool
    metallb.universe.tf/address-pool: istio-pool
    # Optional: Request a specific IP from the pool for consistency
    # This is useful when you need a predictable IP for DNS configuration
    metallb.universe.tf/loadBalancerIPs: "192.168.254.150"
  labels:
    app: istio-ingressgateway
    istio: ingressgateway
spec:
  type: LoadBalancer
  # externalTrafficPolicy: Local preserves client source IP
  # This is important for access logging and IP-based policies
  externalTrafficPolicy: Local
  selector:
    app: istio-ingressgateway
    istio: ingressgateway
  ports:
  # Standard HTTP port for unencrypted traffic or HTTP->HTTPS redirect
  - name: http2
    port: 80
    targetPort: 8080
    protocol: TCP
  # Standard HTTPS port for TLS-encrypted traffic
  - name: https
    port: 443
    targetPort: 8443
    protocol: TCP
  # Status port for health checks and metrics scraping
  - name: status-port
    port: 15021
    targetPort: 15021
    protocol: TCP