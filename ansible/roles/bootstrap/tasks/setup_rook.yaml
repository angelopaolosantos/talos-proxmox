---
# file: roles/controlplane/tasks/setup_rook.yaml

- name: Clone the rook repository
  ansible.builtin.git:
    repo: 'https://github.com/rook/rook.git'
    dest: '/tmp/ceph-k8s/rook/'
    clone: yes
    update: yes

- name: Apply rook/deploy/examples/crds.yaml
  vars:
    ansible_python_interpreter: /opt/k8s_venv/bin/python
  kubernetes.core.k8s:
    state: absent
    kubeconfig: "{{ kubeconfig_temp_path }}"
    src: "/tmp/ceph-k8s/rook/deploy/examples/crds.yaml"

- name: Apply rook/deploy/examples/common.yaml
  vars:
    ansible_python_interpreter: /opt/k8s_venv/bin/python
  kubernetes.core.k8s:
    state: absent
    kubeconfig: "{{ kubeconfig_temp_path }}"
    src: "/tmp/ceph-k8s/rook/deploy/examples/common.yaml"

- name: Apply rook/deploy/examples/operator.yaml
  vars:
    ansible_python_interpreter: /opt/k8s_venv/bin/python
  kubernetes.core.k8s:
    state: absent
    kubeconfig: "{{ kubeconfig_temp_path }}"
    src: "/tmp/ceph-k8s/rook/deploy/examples/operator.yaml"

- name: Add rook helm chart repo
  kubernetes.core.helm_repository:
    name: rook-release
    repo_url: "https://charts.rook.io/release"

- name: Deploy the Helm chart rook-ceph-cluster
  kubernetes.core.helm:
    kubeconfig: "{{ kubeconfig_temp_path }}"
    release_name: rook-ceph-cluster  # Release name
    release_namespace: rook-ceph
    create_namespace: true
    chart_ref: "rook-release/rook-ceph-cluster"
    release_state: absent
    release_values:
      operatorNamespace: rook-ceph
    values_files:
      - /tmp/ceph-k8s/rook/deploy/charts/rook-ceph-cluster/values-external.yaml